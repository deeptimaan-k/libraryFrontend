<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Shakya Digital Library - Fees Dashboard</title>
    <link rel="stylesheet" href="./css/dashboard.css">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 0;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 700px;
            margin: 50px auto;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid #ddd;
        }

        h1,
        h2 {
            text-align: center;
            color: #4A90E2;
            margin-bottom: 20px;
            font-weight: 400;
        }

        .form-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .form-group label {
            flex: 1;
            margin-right: 20px;
            min-width: 100px;
            color: #555;
            font-weight: bold;
        }

        .form-group input,
        .form-group select {
            flex: 2;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: inset 0px 1px 3px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }

        .button {
            display: block;
            width: 100%;
            max-width: 200px;
            margin: 20px auto;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background-color: #4A90E2;
            color: #fff;
            cursor: pointer;
            text-align: center;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        .button:hover {
            background-color: #357ABD;
        }

        .loading-css {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
        }

        .loading-css img {
            width: 50px;
        }

        .student-details,
        .fee-status,
        .fee-receipt-form {
            margin-top: 20px;
            padding: 20px;
            background-color: #f7f7f7;
            border-radius: 10px;
            border: 1px solid #ddd;
        }

        .student-details p,
        .fee-status p {
            margin: 10px 0;
            font-size: 14px;
            line-height: 1.5;
        }

        .fee-status h2 {
            margin-bottom: 15px;
        }

        .input-container {
            display: flex;
            align-items: center;
        }

        .input-container input {
            flex-grow: 1;
        }

        .fee-card {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .fee-card.green {
            background-color: #28a745;
        }

        .fee-card.red {
            background-color: #dc3545;
        }

        .fee-card span {
            font-weight: bold;
        }

        /* Styling for fee table */
        #feeTable {
            width: 100%;
            border-collapse: collapse;
        }

        #feeTable th,
        #feeTable td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        #feeTable th {
            background-color: #4A90E2;
            color: white;
            font-weight: bold;
        }

        #feeTable tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        #feeTable tr:hover {
            background-color: #ddd;
        }
    </style>
</head>

<body>
    <div id="nav-placeholder"></div>
    <div id="navigation"></div>
    <!-- <img src="../../index.html" -->
    <script>
        // Function to fetch and render the navigation component
        function loadNavigation() {
            var xhttpHTML = new XMLHttpRequest();
            xhttpHTML.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    document.getElementById("navigation").innerHTML = this.responseText;
                    loadCSS();
                    loadScript();
                }
            };
            xhttpHTML.open("GET", "./NavigationBar/nav.html", true);
            xhttpHTML.send();
        }

        // Function to load the CSS file for the navigation component
        function loadCSS() {
            var link = document.createElement('link');
            link.rel = 'stylesheet';
            link.type = 'text/css';
            link.href = './NavigationBar/NavStyle.css';
            document.head.appendChild(link);
        }

        // Function to load the JavaScript file for the navigation component
        function loadScript() {
            var script = document.createElement('script');
            script.src = './NavigationBar/NavScript.js';
            document.body.appendChild(script);
        }

        // Load the navigation component
        loadNavigation();
    </script>
    <div class="container">
        <h1>Fees Dashboard</h1>

        <!-- Form to Fetch Student Data -->
        <form id="studentForm">
            <div class="form-group input-container">
                <label for="rollNumber">Reg No. :</label>
                <input type="text" id="rollNumber" name="rollNumber" required placeholder="Enter registration number">
                <button class="button" type="button" onclick="fetchStudentData()">Fetch Data</button>
            </div>
        </form>

        <!-- Display Student Details -->
        <div id="studentDetails" class="student-details" style="display: none;">
            <h2>Student Details</h2>
            <p><strong>Name:</strong> <span id="name"></span></p>
            <p><strong>Gender:</strong> <span id="gender"></span></p>
            <p><strong>Date of Birth:</strong> <span id="dob"></span></p>
            <p><strong>Aadhar Number:</strong> <span id="aadharNo"></span></p>
            <p><strong>Mobile No.:</strong> <span id="contact"></span></p>
            <p><strong>Father's Name:</strong> <span id="Fname"></span></p>
            <p><strong>Father's Occupation:</strong> <span id="FOccupation"></span></p>
            <p><strong>Permanent Address:</strong> <span id="permanentAddress"></span></p>
            <p><strong>Postal Address:</strong> <span id="postalAddress"></span></p>
            <p><strong>Academic:</strong> <span id="academic"></span></p>
            <p><strong>Prepare For:</strong> <span id="prepareFor"></span></p>
            <p><strong>Date of Admission:</strong> <span id="dateOfAdmission"></span></p>
            <p><strong>Slots:</strong> <span id="slots"></span></p>
        </div>

        <!-- Display Fee Statements -->
        <div id="feeStatements" class="fee-status" style="display: none;">
            <h2>Fee Statements</h2>
            <table id="feeTable">
                <thead>
                    <tr>
                        <th>Year</th>
                        <th>Month</th>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Payment Method</th>
                        <th>Receipt Number</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Fee records will be injected here -->
                </tbody>
            </table>
        </div>

        <!-- Display Upcoming Fees -->
        <div id="upcomingFees" class="fee-status" style="display: none;">
            <h2>Fees Summary</h2>
            <ul id="upcomingFeesList">
                <!-- Upcoming fees will be listed here -->
            </ul>
        </div>

        <!-- Form to Submit Fee Details -->
        <div id="submitFeeForm" class="fee-receipt-form" style="display: none;">
            <h2>Submit Fee Details</h2>
            <form id="feeForm">
                <div class="form-group">
                    <label for="year">Year:</label>
                    <input type="number" id="year" name="year" required>
                </div>
                <div class="form-group">
                    <label for="month">Month:</label>
                    <select id="month" name="month" required>
                        <option value="">Select Month</option>
                        <option value=1>January</option>
                        <option value=2>February</option>
                        <option value=3>March</option>
                        <option value=4>April</option>
                        <option value=5>May</option>
                        <option value=6>June</option>
                        <option value=7>July</option>
                        <option value=8>August</option>
                        <option value=8>September</option>
                        <option value=10>October</option>
                        <option value=11>November</option>
                        <option value=12>December</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="amount">Amount:</label>
                    <input type="number" id="amount" name="amount" required min="0">
                </div>
                <div class="form-group">
                    <label for="paymentMethod">Payment Method:</label>
                    <select id="paymentMethod" name="paymentMethod" required>
                        <option value="">Select Payment Method</option>
                        <option value="cash">Cash</option>
                        <option value="card">Card</option>
                        <option value="online">Online</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="receiptNumber">Receipt Number:</label>
                    <input type="text" id="receiptNumber" name="receiptNumber" required>
                </div>
                <button class="button" type="button" onclick="submitFeeDetails()">Submit Fee</button>
            </form>
        </div>
    </div>

    <script>
        let studentObjectId = '';
        let selectedFeeId = '';

        async function fetchStudentData() {
    const rollNumber = document.getElementById("rollNumber").value.trim();

    if (rollNumber === "") {
        alert("Please enter the registration number.");
        return;
    }

    try {
        const response = await fetch(`http://localhost:3000/students/${rollNumber}`);
        if (!response.ok) {
            throw new Error('Student not found.');
        }
        const student = await response.json();

        studentObjectId = student._id;

        // Helper function to format date
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        }

        // Populate student details
        document.getElementById("name").innerText = student.name || 'N/A';
        document.getElementById("gender").innerText = student.gender || 'N/A';
        document.getElementById("dob").innerText = formatDate(student.dob);
        document.getElementById("aadharNo").innerText = student.aadharNo || 'N/A';
        document.getElementById("contact").innerText = student.contact || 'N/A';
        document.getElementById("Fname").innerText = student.Fname || 'N/A';
        document.getElementById("FOccupation").innerText = student.FOccupation || 'N/A';
        document.getElementById("permanentAddress").innerText = student.permanentAddress || 'N/A';
        document.getElementById("postalAddress").innerText = student.postalAddress || 'N/A';
        document.getElementById("academic").innerText = student.academic || 'N/A';
        document.getElementById("prepareFor").innerText = student.prepareFor || 'N/A';
        document.getElementById("dateOfAdmission").innerText = formatDate(student.dateOfAdmission);
        document.getElementById("slots").innerText = student.slots || 'N/A';

        document.getElementById("studentDetails").style.display = "block";

        await fetchFeeStatements();
        await checkUpcomingFees();

    } catch (error) {
        alert("Error fetching student data: " + error.message);
    }
}


        async function fetchFeeStatements() {
            function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        }
    try {
        const response = await fetch(`http://localhost:3000/fees/${studentObjectId}`);
        if (!response.ok) {
            throw new Error('An error occurred while fetching fee statements');
        }

        const feeStatements = await response.json();
        console.log(feeStatements);
        const feeTableBody = document.querySelector("#feeTable tbody");
        feeTableBody.innerHTML = ''; // Clear previous data

        // Mapping month numbers to month names
        const monthNames = [
            "January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"
        ];

        feeStatements.forEach(fee => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${fee.year}</td>
                <td>${monthNames[fee.month - 1]}</td> <!-- Convert month number to month name -->
                <td>${formatDate(fee.dateOfPayment)}</td>
                <td>${fee.amount}</td>
                <td>${fee.paymentMethod}</td>
                <td>${fee.receiptNumber}</td>
            `;
            feeTableBody.appendChild(row);
        });

        document.getElementById("feeStatements").style.display = "block";

    } catch (error) {
        alert("Error fetching fee statements: " + error.message);
    }
}


        async function checkUpcomingFees() {
            try {
                const currentYear = new Date().getFullYear();
                const months = [
                    { name: "January", number: 1 },
                    { name: "February", number: 2 },
                    { name: "March", number: 3 },
                    { name: "April", number: 4 },
                    { name: "May", number: 5 },
                    { name: "June", number: 6 },
                    { name: "July", number: 7 },
                    { name: "August", number: 8 },
                    { name: "September", number: 9 },
                    { name: "October", number: 10 },
                    { name: "November", number: 11 },
                    { name: "December", number: 12 }
                ];

                // Get existing fees
                const response = await fetch(`http://localhost:3000/fees/${studentObjectId}`, {
                    method: "GET"
                });

                if (!response.ok) {
                    throw new Error('An error occurred while fetching fee statements');
                }

                const feeStatements = await response.json();
                const paidFees = feeStatements.map(fee => `${fee.year}-${fee.month}`);
                const upcomingFeesList = document.getElementById("upcomingFeesList");
                upcomingFeesList.innerHTML = ''; // Clear previous data

                months.forEach(month => {
                    const currentMonthYear = `${currentYear}-${month.number}`;
                    const isSubmitted = paidFees.includes(currentMonthYear);
                    const card = document.createElement("li");
                    card.className = `fee-card ${isSubmitted ? 'green' : 'red'}`;
                    card.dataset.year = currentYear;
                    card.dataset.month = month.name;
                    card.innerHTML = `
                        <span>${month.name} ${currentYear}</span>
                        <span>${isSubmitted ? 'Submitted' : 'Not Submitted'}</span>
                    `;
                    card.addEventListener("click", () => {
                        if (!isSubmitted) {
                            showFeeForm(currentYear, month.number);
                        }
                    });
                    upcomingFeesList.appendChild(card);
                });

                document.getElementById("upcomingFees").style.display = "block";

            } catch (error) {
                alert("Error checking upcoming fees: " + error.message);
            }
        }

        function showFeeForm(year, month) {
            // Set form values
            document.getElementById("year").value = year;
            document.getElementById("month").value = month;
            document.getElementById("amount").value = '';
            document.getElementById("paymentMethod").value = '';
            document.getElementById("receiptNumber").value = '';

            // Show the fee submission form
            document.getElementById("submitFeeForm").style.display = "block";
        }

        function isValidAmount(amount) {
            return !isNaN(amount) && amount >= 0;
        }

        async function submitFeeDetails() {
            const year = document.getElementById("year").value;
            const month = document.getElementById("month").value;
            const amount = document.getElementById("amount").value;
            const paymentMethod = document.getElementById("paymentMethod").value;
            const receiptNumber = document.getElementById("receiptNumber").value;

            if (!year || !month || !isValidAmount(amount) || !paymentMethod || !receiptNumber) {
                alert("Please fill in all fields with valid data.");
                return;
            }

            try {
                const response = await fetch(`http://localhost:3000/fees/${studentObjectId}`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ year, month, amount, paymentMethod, receiptNumber })
                });

                if (!response.ok) {
                    throw new Error('An error occurred while submitting fee details');
                }

                alert("Fee details submitted successfully.");
                document.getElementById("submitFeeForm").style.display = "none";
                await fetchFeeStatements();
                await checkUpcomingFees();

            } catch (error) {
                alert("Error submitting fee details: " + error.message);
            }
        }

        async function updateFeeDetails() {
            const year = document.getElementById("year").value;
            const month = document.getElementById("month").value;
            const amount = document.getElementById("amount").value;
            const paymentMethod = document.getElementById("paymentMethod").value;
            const receiptNumber = document.getElementById("receiptNumber").value;

            if (!year || !month || !isValidAmount(amount) || !paymentMethod || !receiptNumber) {
                alert("Please fill in all fields with valid data.");
                return;
            }

            try {
                const response = await fetch(`http://localhost:3000/fees/${studentObjectId}/${selectedFeeId}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ year, month, amount, paymentMethod, receiptNumber })
                });

                if (!response.ok) {
                    throw new Error('An error occurred while updating fee details');
                }

                alert("Fee details updated successfully.");
                document.getElementById("submitFeeForm").style.display = "none";
                await fetchFeeStatements();
                await checkUpcomingFees();

            } catch (error) {
                alert("Error updating fee details: " + error.message);
            }
        }
    </script>
</body>

</html>
